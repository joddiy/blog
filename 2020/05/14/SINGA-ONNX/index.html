
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Jz Blog">
    <title>SINGA-ONNX - Jz Blog</title>
    <meta name="author" content="Joddiy Zhang">
    
    
        <link rel="icon" href="http://joddiy.cc/assets/images/favicon.ico">
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Joddiy Zhang","sameAs":["https://github.com/joddiy","https://scholar.google.com/citations?user=KH-xv38AAAAJ&hl=en&oi=sra","https://www.linkedin.com/in/joddiyzhang/"],"image":"14108933.jpeg"},"articleBody":"Conslusion firstGood news: \n\nThe ONNX can defines the loss and optimizer now within its format. However, current loss only have NegativeLogLikelihoodLoss and SoftmaxCrossEntropyLoss. Also, it only can store optimizers, only have Adagrad, Adam, Momentum(SGD with standard momentum). \n\nBad news:\n\nwe need to update the onnx to 1.7, which is released last week, may not be so stable. In this release, ONNX defines a comlicated node called GraphCall to specify which gradients should be computed and how to update the tensors by using these gradients. Since we will update the weights following the backward, so this part may not be useful for us.\n\nONNX Training Preview (TrainingInfoProto)In last week, the ONNX team has released a new version 1.7.0 which upgrade its opset version to 12. In this new rleases, they add a new feature called TrainingInfoProto. \nThis new feature defines something about training information. There are two main parts in it, initialization-step and training-algorithm-step.\ninitialization-stepinitialization-step means the developer can defines a initialization. For its type, the initialization is a formal ONNX graph. It doesn’t have input but seveal outputs. The developer can defines some nodes in this graph, such as RandomNormal or RandomUniform, and in another field called initialization_binding, the developer can assign these outputs to the specific tensors in the inference graph.\nThe current supported ramdom methods are: RandomNormal or RandomUniform.\ntraining-algorithm-steptraining-algorithm-step defines a field called algorithm. It defines a inference graph which represents a training algorithm’s step. Given required inputs, it computes outputs to update tensors in its own or in the main computaton graph. update_binding contains a key-value pair of strings to assign the outputs to some specific tensors.\nIn general, this graph contains loss node, gradient node, optimizer node, increment of iteration count, and some calls to the inference graph. The field algorithm.node is the only place the user can use GraphCall operator. \nLoss node\nNegativeLogLikelihoodLoss\nSoftmaxCrossEntropyLoss\n\nOptimizer node\nAdagrad\nAdam\nMomentum: SG with standard momentum\n\nGradient nodeThe gradient node actually only defines the necessary information to compute the gradient for all graph, for example, at the following graph, the gradient defines its inputs containing the xs(intermidate weights) and zs(input of the graph), and y(the output of the graph), and its outputs having dY/dW, dY/dZ whose order corresponds to the inputs in xs. \nIt doesn’t defines any logic about how to compute the dY/dW, dY/dZ.\n1234567891011121314W --&gt; Conv --&gt; H --&gt; Gemm --&gt; Y|      ^              ^|      |              ||      X              Z|      |              ||      |   .----------&#x27;|      |   |  (W/Z/X is the 1st/2nd/3rd input of Gradient as shown in|      |   |   &quot;xs&quot; followed by &quot;zs&quot;)|      v   v&#x27;---&gt; Gradient(xs=[&quot;W&quot;, &quot;Z&quot;], zs=[&quot;X&quot;], y=&quot;Y&quot;)       |   |       |   &#x27;-----------------------------------&gt; dY/dW (1st output of Gradient)       |       &#x27;---------------------------------------&gt; dY/dZ (2nd output of Gradient)\n\nGraphCall nodeThe GraphCall operator invokes a graph inside TrainingInfoProto’s algorithm field. The GraphCall inputs and outputs are bound to those of invoked graph by position.\nBased on the above inference graph, the GraphCall can use like this:\n123456789101112131415161718192021222324252627282930.-------- W (a global and mutable variable from|         |  the inference graph)|         ||   .-----&#x27;-----------.|   |                 ||   |                 v|   | .-- X_1 --&gt; GraphCall(graph_name=&quot;MyInferenceGraph&quot;)|   | |            |  ||   | |            |  ||   | |   Z_1 -----&#x27;  ||   | |    |          V|   | |    |         Y_1 ---&gt; Loss ---&gt; O|   | |    |                    ^|   | |    |                    ||   | `--. |                    C|   |    | |                    ||   |    | |   .----------------&#x27;|   |    | |   ||   |    v v   v|   `--&gt; Gradient(xs=[&quot;W&quot;], zs=[&quot;X_1&quot;, &quot;Z_1&quot;, &quot;C&quot;], y=&quot;O&quot;)|        ||        v|      dO_dW (gradient of W)      1 (a scalar one)|        |                        ||        V                        v|       Div &lt;--- T ------------&gt; Add ---&gt; T_new|        |    (T is the number of training iterations.|        |     T is also globally visible and mutable.)|        v`-----&gt; Sub ----&gt; W_new\n\nThe previous section’s inference graph is called by GraphCall(graph_name=&quot;MyInferenceGraph&quot;), and it uses a new batch of inputs (X_1, Z_1) to compute Y_1. \nGradient defines the graidents the graph should compute, finally, it gets W_new amd T_new.\nThe it uses the following update_binding to udpate the tensors:\n1update_binding: &#123;&quot;W&quot;: &quot;W_new&quot;, &quot;T&quot;: &quot;T_new&quot;&#125;\n\nAPI12345678910111213141516171819202122232425262728293031323334353637383940414243# handle ONNX def to_onnx(model):    return a onnx model class SONNXModel(Module):\tdef __init__(self, onnx_model):\t\tsinga_rep = sonnx.prepare(onnx_model, device=dev, batchsize=1)\t\tfor layer_name, layer in singa_rep.layers:\t\t\tself.__dict__[layer_name] = layer\t\t# store weights here as numpy\t\tfor weith_name, weight in singa_rep.weights:\t\t\tself.weights[weith_name] = weight\t\t# store layer info such as input and output name(only weights)\t\tfor layer_name, layer_info in singa_rep.layer_infos:\t\t\tself.layer_infos[layer_name] = layer_info    def forward(self, aux_output):        # run forward according to onnx graph         return the last output + aux_output    def compile(self)    \t# init weights    \tsuper.compile(self)    \t# set weights&#x27; value\t\tfor layer_name, layer in self.__dict__:\t\t\tinput_info, output_info = self.layer_infos[layer_name]\t\t\tfor input_name in input_info:\t\t\t\tlayer.set_weight(self.weights[input_name])class MyModel(SONNXModel):     def __init__(self, onnx):          super.__init__(onnx)          self.layer1 = Conv()          self.layer2 = Conv()     def forward(self, x):           x1, x2 = super.forward(x, aux_output)           x = self.layer1.forward(x2)           return self.layer2.forward(x1) + x      def train_one_batch(self, x, y):           y_ = self.forward(x)           ....\n\n\nsave and load: how to load onnx model, and how to save loss and sgd\n","dateCreated":"2020-05-14T16:54:44+08:00","dateModified":"2020-09-22T17:44:18+08:00","datePublished":"2020-05-14T16:54:44+08:00","description":"some upgrade about SINGA ONNX","headline":"SINGA-ONNX","image":["https://pbs.twimg.com/profile_images/905661894672883712/8nx8F7zi_400x400.jpg","https://www.cdotrends.com/sites/default/files/NUS.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"http://joddiy.cc/2020/05/14/SINGA-ONNX/"},"publisher":{"@type":"Organization","name":"Joddiy Zhang","sameAs":["https://github.com/joddiy","https://scholar.google.com/citations?user=KH-xv38AAAAJ&hl=en&oi=sra","https://www.linkedin.com/in/joddiyzhang/"],"image":"14108933.jpeg","logo":{"@type":"ImageObject","url":"14108933.jpeg"}},"url":"http://joddiy.cc/2020/05/14/SINGA-ONNX/","keywords":"Deep Learning, Work, SINGA","thumbnailUrl":"https://pbs.twimg.com/profile_images/905661894672883712/8nx8F7zi_400x400.jpg"}</script>
    <meta name="description" content="some upgrade about SINGA ONNX">
<meta property="og:type" content="blog">
<meta property="og:title" content="SINGA-ONNX">
<meta property="og:url" content="http://joddiy.cc/2020/05/14/SINGA-ONNX/index.html">
<meta property="og:site_name" content="Jz Blog">
<meta property="og:description" content="some upgrade about SINGA ONNX">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-05-14T08:54:44.000Z">
<meta property="article:modified_time" content="2020-09-22T09:44:18.000Z">
<meta property="article:author" content="Joddiy Zhang">
<meta property="article:tag" content="Deep Learning">
<meta property="article:tag" content="Work">
<meta property="article:tag" content="SINGA">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="http://joddiy.cc/assets/images/14108933.jpeg"/>
    
    
        <meta property="og:image" content="https://pbs.twimg.com/profile_images/905661894672883712/8nx8F7zi_400x400.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://pbs.twimg.com/profile_images/905661894672883712/8nx8F7zi_400x400.jpg"/>
    
    
        <meta property="og:image" content="https://www.cdotrends.com/sites/default/files/NUS.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://www.cdotrends.com/sites/default/files/NUS.jpg"/>
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-x8blglznjjnb9pnnwui5zw4h43ysufmsh1b0omicawm4vhqcutzqavokgpne.min.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Jz Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/14108933.jpeg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/14108933.jpeg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Joddiy Zhang</h4>
                
                    <h5 class="sidebar-profile-bio"><p><a href="mailto:&#x6a;&#111;&#x64;&#100;&#105;&#x79;&#122;&#104;&#x61;&#x6e;&#x67;&#64;&#103;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#x6a;&#111;&#x64;&#100;&#105;&#x79;&#122;&#104;&#x61;&#x6e;&#x67;&#64;&#103;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#99;&#x6f;&#109;</a></p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/joddiy"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://scholar.google.com/citations?user=KH-xv38AAAAJ&hl=en&oi=sra"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Google Scholar"
                        >
                        <i class="sidebar-button-icon fab fa-google" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Google Scholar</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/joddiyzhang/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-center
                    post-header-cover--partial"
             style="background-image:url('https://www.cdotrends.com/sites/default/files/NUS.jpg');"
             data-behavior="4">
            
                <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title">
            SINGA-ONNX
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-05-14T16:54:44+08:00">
	
		    May 14, 2020
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Work-Notes/">Work Notes</a>


    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h2 id="Conslusion-first"><a href="#Conslusion-first" class="headerlink" title="Conslusion first"></a>Conslusion first</h2><p>Good news: </p>
<blockquote>
<p>The ONNX can defines the loss and optimizer now within its format. However, current loss only have <code>NegativeLogLikelihoodLoss</code> and <code>SoftmaxCrossEntropyLoss</code>. Also, it only can store optimizers, only have <code>Adagrad</code>, <code>Adam</code>, <code>Momentum</code>(SGD with standard momentum). </p>
</blockquote>
<p>Bad news:</p>
<blockquote>
<p>we need to update the onnx to 1.7, which is released last week, may not be so stable. In this release, ONNX defines a comlicated node called <code>GraphCall</code> to specify which gradients should be computed and how to update the tensors by using these gradients. Since we will update the weights following the backward, so this part may not be useful for us.</p>
</blockquote>
<h2 id="ONNX-Training-Preview-TrainingInfoProto"><a href="#ONNX-Training-Preview-TrainingInfoProto" class="headerlink" title="ONNX Training Preview (TrainingInfoProto)"></a>ONNX Training Preview (TrainingInfoProto)</h2><p>In last week, the ONNX team has released a new version <a target="_blank" rel="noopener" href="https://github.com/onnx/onnx/releases/tag/v1.7.0">1.7.0</a> which upgrade its opset version to 12. In this new rleases, they add a new feature called <a target="_blank" rel="noopener" href="https://github.com/onnx/onnx/blob/3368834cf0b1f0ab9838cf6bdf78a27299d08187/onnx/onnx.proto3#L211-L316"><code>TrainingInfoProto</code></a>. </p>
<p>This new feature defines something about training information. There are two main parts in it, <code>initialization-step</code> and <code>training-algorithm-step</code>.</p>
<h3 id="initialization-step"><a href="#initialization-step" class="headerlink" title="initialization-step"></a>initialization-step</h3><p><code>initialization-step</code> means the developer can defines a <code>initialization</code>. For its type, the <code>initialization</code> is a formal ONNX graph. It doesn’t have input but seveal outputs. The developer can defines some nodes in this graph, such as <code>RandomNormal</code> or <code>RandomUniform</code>, and in another field called <code>initialization_binding</code>, the developer can assign these outputs to the specific tensors in the inference graph.</p>
<p>The current supported ramdom methods are: <code>RandomNormal</code> or <code>RandomUniform</code>.</p>
<h3 id="training-algorithm-step"><a href="#training-algorithm-step" class="headerlink" title="training-algorithm-step"></a>training-algorithm-step</h3><p><code>training-algorithm-step</code> defines a field called <code>algorithm</code>. It defines a inference graph which represents a training algorithm’s step. Given required inputs, it computes outputs to update tensors in its own or in the main computaton graph. <code>update_binding</code> contains a key-value pair of strings to assign the outputs to some specific tensors.</p>
<p>In general, this graph contains loss node, gradient node, optimizer node, increment of iteration count, and some calls to the inference graph. The field algorithm.node is the only place the user can use GraphCall operator. </p>
<h4 id="Loss-node"><a href="#Loss-node" class="headerlink" title="Loss node"></a>Loss node</h4><ul>
<li><code>NegativeLogLikelihoodLoss</code></li>
<li><code>SoftmaxCrossEntropyLoss</code></li>
</ul>
<h4 id="Optimizer-node"><a href="#Optimizer-node" class="headerlink" title="Optimizer node"></a>Optimizer node</h4><ul>
<li><code>Adagrad</code></li>
<li><code>Adam</code></li>
<li><code>Momentum</code>: SG with standard momentum</li>
</ul>
<h4 id="Gradient-node"><a href="#Gradient-node" class="headerlink" title="Gradient node"></a>Gradient node</h4><p>The gradient node actually only defines the necessary information to compute the gradient for all graph, for example, at the following graph, the gradient defines its inputs containing the <code>xs</code>(intermidate weights) and <code>zs</code>(input of the graph), and <code>y</code>(the output of the graph), and its outputs having <code>dY/dW</code>, <code>dY/dZ</code> whose order corresponds to the inputs in <code>xs</code>. </p>
<p>It doesn’t defines any logic about how to compute the <code>dY/dW</code>, <code>dY/dZ</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">W --&gt; Conv --&gt; H --&gt; Gemm --&gt; Y</span><br><span class="line">|      ^              ^</span><br><span class="line">|      |              |</span><br><span class="line">|      X              Z</span><br><span class="line">|      |              |</span><br><span class="line">|      |   .----------&#x27;</span><br><span class="line">|      |   |  (W/Z/X is the 1st/2nd/3rd input of Gradient as shown in</span><br><span class="line">|      |   |   &quot;xs&quot; followed by &quot;zs&quot;)</span><br><span class="line">|      v   v</span><br><span class="line">&#x27;---&gt; Gradient(xs=[&quot;W&quot;, &quot;Z&quot;], zs=[&quot;X&quot;], y=&quot;Y&quot;)</span><br><span class="line">       |   |</span><br><span class="line">       |   &#x27;-----------------------------------&gt; dY/dW (1st output of Gradient)</span><br><span class="line">       |</span><br><span class="line">       &#x27;---------------------------------------&gt; dY/dZ (2nd output of Gradient)</span><br></pre></td></tr></table></figure>

<h4 id="GraphCall-node"><a href="#GraphCall-node" class="headerlink" title="GraphCall node"></a>GraphCall node</h4><p>The GraphCall operator invokes a graph inside TrainingInfoProto’s algorithm field. The GraphCall inputs and outputs are bound to those of invoked graph by position.</p>
<p>Based on the above inference graph, the GraphCall can use like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.-------- W (a global and mutable variable from</span><br><span class="line">|         |  the inference graph)</span><br><span class="line">|         |</span><br><span class="line">|   .-----&#x27;-----------.</span><br><span class="line">|   |                 |</span><br><span class="line">|   |                 v</span><br><span class="line">|   | .-- X_1 --&gt; GraphCall(graph_name=&quot;MyInferenceGraph&quot;)</span><br><span class="line">|   | |            |  |</span><br><span class="line">|   | |            |  |</span><br><span class="line">|   | |   Z_1 -----&#x27;  |</span><br><span class="line">|   | |    |          V</span><br><span class="line">|   | |    |         Y_1 ---&gt; Loss ---&gt; O</span><br><span class="line">|   | |    |                    ^</span><br><span class="line">|   | |    |                    |</span><br><span class="line">|   | `--. |                    C</span><br><span class="line">|   |    | |                    |</span><br><span class="line">|   |    | |   .----------------&#x27;</span><br><span class="line">|   |    | |   |</span><br><span class="line">|   |    v v   v</span><br><span class="line">|   `--&gt; Gradient(xs=[&quot;W&quot;], zs=[&quot;X_1&quot;, &quot;Z_1&quot;, &quot;C&quot;], y=&quot;O&quot;)</span><br><span class="line">|        |</span><br><span class="line">|        v</span><br><span class="line">|      dO_dW (gradient of W)      1 (a scalar one)</span><br><span class="line">|        |                        |</span><br><span class="line">|        V                        v</span><br><span class="line">|       Div &lt;--- T ------------&gt; Add ---&gt; T_new</span><br><span class="line">|        |    (T is the number of training iterations.</span><br><span class="line">|        |     T is also globally visible and mutable.)</span><br><span class="line">|        v</span><br><span class="line">`-----&gt; Sub ----&gt; W_new</span><br></pre></td></tr></table></figure>

<p>The previous section’s inference graph is called by <code>GraphCall(graph_name=&quot;MyInferenceGraph&quot;)</code>, and it uses a new batch of inputs (<code>X_1</code>, <code>Z_1</code>) to compute <code>Y_1</code>. </p>
<p><code>Gradient</code> defines the graidents the graph should compute, finally, it gets <code>W_new</code> amd <code>T_new</code>.</p>
<p>The it uses the following <code>update_binding</code> to udpate the tensors:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update_binding: &#123;&quot;W&quot;: &quot;W_new&quot;, &quot;T&quot;: &quot;T_new&quot;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># handle ONNX </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_onnx</span>(<span class="params">model</span>):</span><br><span class="line">    <span class="keyword">return</span> a onnx model </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SONNXModel</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, onnx_model</span>):</span><br><span class="line">		singa_rep = sonnx.prepare(onnx_model, device=dev, batchsize=<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">for</span> layer_name, layer <span class="keyword">in</span> singa_rep.layers:</span><br><span class="line">			self.__dict__[layer_name] = layer</span><br><span class="line">		<span class="comment"># store weights here as numpy</span></span><br><span class="line">		<span class="keyword">for</span> weith_name, weight <span class="keyword">in</span> singa_rep.weights:</span><br><span class="line">			self.weights[weith_name] = weight</span><br><span class="line">		<span class="comment"># store layer info such as input and output name(only weights)</span></span><br><span class="line">		<span class="keyword">for</span> layer_name, layer_info <span class="keyword">in</span> singa_rep.layer_infos:</span><br><span class="line">			self.layer_infos[layer_name] = layer_info</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, aux_output</span>):</span><br><span class="line">        <span class="comment"># run forward according to onnx graph </span></span><br><span class="line">        <span class="keyword">return</span> the last output + aux_output</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compile</span>(<span class="params">self</span>)</span><br><span class="line">    	<span class="comment"># init weights</span></span><br><span class="line">    	<span class="built_in">super</span>.<span class="built_in">compile</span>(self)</span><br><span class="line">    	<span class="comment"># set weights&#x27; value</span></span><br><span class="line">		<span class="keyword">for</span> layer_name, layer <span class="keyword">in</span> self.__dict__:</span><br><span class="line">			input_info, output_info = self.layer_infos[layer_name]</span><br><span class="line">			<span class="keyword">for</span> input_name <span class="keyword">in</span> input_info:</span><br><span class="line">				layer.set_weight(self.weights[input_name])</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyModel</span>(<span class="title class_ inherited__">SONNXModel</span>):</span><br><span class="line">     <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, onnx</span>):</span><br><span class="line">          <span class="built_in">super</span>.__init__(onnx)</span><br><span class="line">          self.layer1 = Conv()</span><br><span class="line">          self.layer2 = Conv()</span><br><span class="line"></span><br><span class="line">     <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">           x1, x2 = <span class="built_in">super</span>.forward(x, aux_output)</span><br><span class="line">           x = self.layer1.forward(x2)</span><br><span class="line">           <span class="keyword">return</span> self.layer2.forward(x1) + x</span><br><span class="line"></span><br><span class="line">      <span class="keyword">def</span> <span class="title function_">train_one_batch</span>(<span class="params">self, x, y</span>):</span><br><span class="line">           y_ = self.forward(x)</span><br><span class="line">           ....</span><br></pre></td></tr></table></figure>

<hr>
<p>save and load: how to load onnx model, and how to save loss and sgd</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Deep-Learning/" rel="tag">Deep Learning</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/SINGA/" rel="tag">SINGA</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Work/" rel="tag">Work</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/05/21/magazine-review/"
                    data-tooltip="Magazine Review May 16th-22nd 2020"
                    aria-label="PREVIOUS: Magazine Review May 16th-22nd 2020"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/05/12/TF2-0-Distributed/"
                    data-tooltip="Notes for Distributed Tensorflow 2.0"
                    aria-label="NEXT: Notes for Distributed Tensorflow 2.0"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://joddiy.cc/2020/05/14/SINGA-ONNX/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://joddiy.cc/2020/05/14/SINGA-ONNX/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://joddiy.cc/2020/05/14/SINGA-ONNX/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 Joddiy Zhang. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/05/21/magazine-review/"
                    data-tooltip="Magazine Review May 16th-22nd 2020"
                    aria-label="PREVIOUS: Magazine Review May 16th-22nd 2020"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/05/12/TF2-0-Distributed/"
                    data-tooltip="Notes for Distributed Tensorflow 2.0"
                    aria-label="NEXT: Notes for Distributed Tensorflow 2.0"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://joddiy.cc/2020/05/14/SINGA-ONNX/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://joddiy.cc/2020/05/14/SINGA-ONNX/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://joddiy.cc/2020/05/14/SINGA-ONNX/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=http://joddiy.cc/2020/05/14/SINGA-ONNX/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=http://joddiy.cc/2020/05/14/SINGA-ONNX/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=http://joddiy.cc/2020/05/14/SINGA-ONNX/"
                        aria-label="Share on Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/14108933.jpeg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Joddiy Zhang</h4>
        
            <div id="about-card-bio"><p><a href="mailto:&#x6a;&#111;&#100;&#100;&#x69;&#x79;&#122;&#x68;&#x61;&#110;&#x67;&#64;&#103;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;">&#x6a;&#111;&#100;&#100;&#x69;&#x79;&#122;&#x68;&#x61;&#110;&#x67;&#64;&#103;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;</a></p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Machine Learning Engineer</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Singapore
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-sqrh47zm5nkjgifq4rx38uvns4r2rarrrvwuhjxiztyrddruca5ukl7nw6br.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
